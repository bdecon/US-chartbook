% % % % % % % % % % % % % % 
%
%	U.S. Chartbook
%	Brian W. Dew (brianwdew@gmail.com)
%	Updated: December 15, 2019
%	GitHub repo contains to do list (issues)
%   https://github.com/bdecon/US-chartbook
%
% % % % % % % % % % % % % %
\PassOptionsToPackage{table}{xcolor}
\documentclass{report}

%
% % % % % % Packages % % % % % % % % % 
%
	
	\usepackage[letterpaper, margin=1.18in]{geometry}
	\usepackage{microtype}
	\usepackage[default]{lato}
	\usepackage{pgfplots, pgfplotstable}
	\usepackage[eulergreek]{sansmath}
	\usepackage{xcolor}
	\usepackage{array}
	\usepackage{fontawesome5}
	\usepackage{titlesec}
	\usepackage{fancyhdr}
	\usepackage[colorlinks, linkcolor=blue, filecolor=blue, 
		citecolor=blue, urlcolor=blue, linktoc=all, 
		pdfencoding=auto]{hyperref}
	\usetikzlibrary{pgfplots.dateplot, pgfplots.fillbetween, patterns}

%
% % % % % Document Settings % % % % % % % 
%

	% Paragraph spacing
	\usepackage{parskip}
	\setlength\parindent{0pt}
	\setlength{\parskip}{8pt}
	\makeatletter
		\newcommand{\@minipagerestore}{\setlength{\parskip}{8pt}}
	\makeatother
	
	% Section and Subsection Headings
	\titleformat{\section}
  		{\color{darkgray} \LARGE \seriffont \bfseries}
  		{\thesection}{1em}{}
	\titleformat{\subsection}
  		{\color{black!70} \seriffont \bfseries \large}
  		{\thesection}{1em}{}
	\titleformat{\subsubsection}
  		{\color{black!70} \seriffont \bfseries \normalsize}
  		{\thesection}{1em}{}		
%
% % % % % Graph Settings % % % % % % % 
%
	
	% Header and footer
	
	\pagestyle{fancy}
	\fancyhf{}
	\renewcommand{\headrulewidth}{0pt}
	\rfoot{\hyperlink{toc}{\faList}}
	\cfoot{\thepage}	
	
	
	% Color square
	\newcommand{\cbox}[1]{
		\begin{tikzpicture} \draw [#1, line width=6](0,0) -- (.2,0);  
		\end{tikzpicture}}
	\newcommand{\colorline}[2]{
		\begin{tikzpicture} \draw [#1, line width=1.8](0,0.2) -- +(0.6,0) node[right, black!80] {#2}; 
		\end{tikzpicture}}
		
	% Table link
	\newcommand{\tbllink}[1]{\href{https://raw.githubusercontent.com/bdecon/US-chartbook/master/chartbook/data/#1}{\faTable}}
	
	% Last two digits of year
	\makeatletter
	\newcommand*\short[1]{\expandafter\@gobbletwo\number\numexpr#1\relax}
	\makeatother	
	
	% Column width and alignment
	\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}	
	
	% Style for date plots
	\pgfplotsset{compat=newest, 
		scaled y ticks=false,
		axis line style={black!20}, 
		xtick style={black!20}, ytick style={draw=none},
		every tick label/.style={black!50, font=\scriptsize,
			/pgf/number format/assume math mode=true},
		width=12.8cm, height=4.8cm, 
		xticklabel style={align=left}, 
		yticklabel style={text width=0.9em, align=right},       
		axis x line*=bottom, x axis line style={black!50},
	    axis y line=left, y axis line style={opacity=0},
	    ymajorgrids, grid style={very thin, black!10},	        
	    every node near coord/.style={/pgf/number format/fixed,
	    	font=\scriptsize, style={black!70}},
	    legend style={legend columns=-1, draw=none, fill=none,
	    	/tikz/every even column/.append style={column sep=0.3cm}}}
	    	
	
	% stacked diverging bar
	\newcommand{\sbar}[4]{
		\addplot[ybar stacked, bar width=2.45pt, draw opacity=0, fill=#1] 
			table [x=#2, y=#3, col sep=comma]{#4};}
			
	% thin stacked diverging bar
	\newcommand{\tsbar}[4]{
		\addplot[ybar stacked, bar width=2.2pt, draw opacity=0, fill=#1] 
			table [x=#2, y=#3, col sep=comma]{#4};}
			
	% custom width stacked diverging bar
	\newcommand{\ctsbar}[5]{
		\addplot[ybar stacked, bar width=#5, draw opacity=0, fill=#1] 
			table [x=#2, y=#3, col sep=comma]{#4};}
			
	% area plot segment
	\newcommand{\abar}[4]{
		\addplot[stack plots=y, area style, draw=none, fill=#1] 
			table [x=#2, y=#3, col sep=comma]{#4}\closedcycle;}
					
	% text node
	\newcommand{\stdnode}[3]{\node[below, align=left, shift=({#1,#2})]{#3};}	
	
	% text node located by data	 
	\newcommand{\absnode}[3]{\node[below right, align=left] at (axis cs: #1,#2) {#3};}        
		        
	% Date (X) Axis Tick Marks, one tick per year, every even year labeled
	\newcommand{\dateaxisticks}{
		date coordinates in=x, axis line style={draw=none},
		xmax={2022-02-28},
		max space between ticks=40,	    
		xtick={{1990-01-01}, {1992-01-01}, {1994-01-01}, 
			{1996-01-01}, {1998-01-01}, {2000-01-01}, 
			{2002-01-01}, {2004-01-01}, {2006-01-01},
			{2008-01-01}, {2010-01-01}, {2012-01-01}, {2014-01-01},
		    {2016-01-01}, {2018-01-01}, {2020-01-01}, {2022-01-01}, 
		    {2024-01-01}, {2026-01-01}},
		minor xtick={{1989-01-01}, {1991-01-01}, {1993-01-01},
			{1995-01-01}, {1997-01-01}, {1999-01-01}, 
			{2001-01-01}, {2003-01-01}, {2005-01-01}, {2007-01-01},
		    {2009-01-01}, {2011-01-01}, {2013-01-01}, {2015-01-01},
		    {2017-01-01}, {2019-01-01}, {2021-01-01}, {2023-01-01}, 
		    {2025-01-01}, {2027-01-01}},
		enlarge y limits={0.06}, enlarge x limits={0.01},
		}
		
	% Date (X) Axis Tick Marks, one tick per year, every even year labeled
	\newcommand{\shdateaxisticks}{
		date coordinates in=x, axis line style={draw=none},
		xmax={2022-02-28},
		max space between ticks=40,	    
		xtick={{1990-01-01}, {1995-01-01}, {2000-01-01}, 
			{2005-01-01}, {2010-01-01}, {2015-01-01}, {2020-01-01}},
		minor xtick={},
		enlarge y limits={0.06}, enlarge x limits={0.01},
		}
		
	% Date (X) Axis Tick Marks, one tick per year, every even year labeled
	\newcommand{\ltdateaxisticks}{
		date coordinates in=x, axis line style={draw=none},
		xmax={2022-02-28},
		max space between ticks=40,	    
		xtick={{2015-01-01}, {2016-01-01}, {2017-01-01}, {2018-01-01}, 
		    {2019-01-01}, {2020-01-01}, {2021-01-01}, {2022-01-01}},
		enlarge y limits={0.06}, enlarge x limits={0.01},
		}
		
	% Date (X) Axis Tick Marks, one tick per year, every even year labeled
	\newcommand{\lfdateaxisticks}{
		date coordinates in=x, axis line style={draw=none},
		xmin={2018-01-01}, xmax={2022-02-28},
		max space between ticks=40,	    
		xtick={{2018-01-01}, {2019-01-01}, {2020-01-01}, {2021-01-01}, {2022-01-01}},
		enlarge y limits={value=0.06, upper}, enlarge x limits={0.02}, ymin=0,
		height=6.2cm, width=6.7cm,
		}
		
	% Date (X) Axis Tick Marks, one tick per year, every even year labeled
	\newcommand{\tydateaxisticks}{
		date coordinates in=x, axis line style={draw=none},
		xmax={2022-02-28}, max space between ticks=40,	    
		xtick={{2011-01-01}, {2012-01-01}, {2013-01-01}, {2014-01-01}, {2015-01-01}, {2016-01-01}, 
			{2017-01-01}, {2018-01-01}, {2019-01-01}, {2020-01-01}, {2021-01-01}, {2022-01-01}},
		enlarge y limits={0.06}, enlarge x limits={0.01},
		}
		
	% Settings for y label text in horizontal bar charts
	\newcommand{\barylab}[2]{yticklabel style={text width=#1, align=right, 
		style={black!70}, text height=#2},}
	
	% Solid bars at significant  x or y values
	\newcommand{\bbar}[2]{extra #1 ticks = {{#2}}, extra #1 tick labels = ,
		extra #1 tick style = {grid=major, grid style={thick, black!25}},}
		
			% Solid bars at significant  x or y values
	\newcommand{\dbar}[2]{extra #1 ticks = {{#2}}, extra #1 tick labels = ,
		extra #1 tick style = {grid=major, grid style={dashed, thick, black!50}},}
		
	% Standard line
	\newcommand{\stdline}[4]{\addplot[very thick, no markers, color=#1] 
		table [x=#2, y=#3, col sep=comma] {#4};	}
		
	% Thin line
	\newcommand{\thinline}[4]{\addplot[no markers, color=#1] 
		table [x=#2, y=#3, col sep=comma] {#4};	}
		
	% Dashed line
	\newcommand{\dashline}[4]{\addplot[very thick, dashed, no markers, color=#1] 
		table [x=#2, y=#3, col sep=comma] {#4};	}
		
	% Thicker line
	\newcommand{\thickline}[4]{\addplot[ultra thick, no markers, color=#1] 
		table [x=#2, y=#3, col sep=comma] {#4};	}
		
	% Style for bar plots legend symbol		
		\pgfplotsset{/pgfplots/area legend/.style={/pgfplots/legend image code/.code={
            \fill[##1] (0cm, -0.1cm) rectangle (0.6cm, 0.1cm);}},}		
		
	% Additional bar plot settings
	\newcommand{\barplotnogrid}{xbar=0pt, axis line style={draw=none},
	    yticklabel style={align=left, anchor=east},
      		xmajorticks=false, ymajorgrids=false,   
	    ytick=data, tickwidth=0pt, area legend, reverse legend,
	    nodes near coords align={horizontal},}  
		
	% Recession bars		
	\newcommand{\rbars}{
		\fill[color=black!10] (axis cs:{1990-07-01},\pgfkeysvalueof{/pgfplots/ymin}) rectangle 
			(axis cs:{1991-03-01}, \pgfkeysvalueof{/pgfplots/ymax});
		\fill[color=black!10] (axis cs:{2007-12-01},\pgfkeysvalueof{/pgfplots/ymin}) rectangle 
			(axis cs:{2009-07-01}, \pgfkeysvalueof{/pgfplots/ymax});
		\fill[color=black!10] (axis cs:{2001-03-01},\pgfkeysvalueof{/pgfplots/ymin}) rectangle 
			(axis cs:{2001-11-01}, \pgfkeysvalueof{/pgfplots/ymax});
		\fill[color=black!10] (axis cs:{2020-02-01},\pgfkeysvalueof{/pgfplots/ymin}) rectangle 
			(axis cs:{2020-05-01}, \pgfkeysvalueof{/pgfplots/ymax});}
			
	\newcommand{\rebars}{
		\fill[color=black!10] (axis cs:{2007-12-01},\pgfkeysvalueof{/pgfplots/ymin}) rectangle 
			(axis cs:{2009-07-01}, \pgfkeysvalueof{/pgfplots/ymax});
		\fill[color=black!10] (axis cs:{2001-03-01},\pgfkeysvalueof{/pgfplots/ymin}) rectangle 
			(axis cs:{2001-11-01}, \pgfkeysvalueof{/pgfplots/ymax});
		\fill[color=black!10] (axis cs:{2020-02-01},\pgfkeysvalueof{/pgfplots/ymin}) rectangle 
			(axis cs:{2020-05-01}, \pgfkeysvalueof{/pgfplots/ymax});}
			
	\newcommand{\recbars}{
		\fill[color=black!10] (axis cs:{2007-12-01},\pgfkeysvalueof{/pgfplots/ymin}) rectangle 
			(axis cs:{2009-07-01}, \pgfkeysvalueof{/pgfplots/ymax});
		\fill[color=black!10] (axis cs:{2020-02-01},\pgfkeysvalueof{/pgfplots/ymin}) rectangle 
			(axis cs:{2020-05-01}, \pgfkeysvalueof{/pgfplots/ymax});}
			
	\newcommand{\rbar}{
		\fill[color=black!10] (axis cs:{2020-02-01},\pgfkeysvalueof{/pgfplots/ymin}) rectangle 
			(axis cs:{2020-05-01}, \pgfkeysvalueof{/pgfplots/ymax});}
	
	\newfontfamily\seriffont{RobotoSlab}	
	
	\pgfplotstableread[header=true, col sep=comma]{data/cpi_comp.csv}\cpi
	\pgfplotstableread[header=true, col sep=semicolon]{data/ip_comp.csv}\ip
	\pgfplotstableread[header=true, col sep=comma]{data/rs_comp.csv}\rs
	\pgfplotstableread[header=true, col sep=comma]{data/ahe_ind.csv}\ahe
	\pgfplotstableread[header=true, col sep=comma]{data/poor.csv}\poor
	\pgfplotstableread[header=true, col sep=comma]{data/poor2.csv}\pvrt
	\pgfplotstableread[header=true, col sep=comma]{data/spmtbl20.csv}\spm
	\pgfplotstableread[header=true, col sep=semicolon]{data/occs.csv}\occ
	\pgfplotstableread[header=true, col sep=comma]{data/empgroups.csv}\emp
	\pgfplotstableread[header=true, col sep=comma]{data/empgroups2.csv}\empt
	\pgfplotstableread[header=true, col sep=comma]{data/unempgroups.csv}\unemp
	\pgfplotstableread[header=true, col sep=comma]{data/unempgroups2.csv}\unempt
	\pgfplotstableread[header=true, col sep=comma]{data/unempgroups3.csv}\unemptt
	\pgfplotstableread[header=true, col sep=semicolon]{data/cps_educ.csv}\edsh
	\pgfplotstableread[header=true, col sep=comma]{data/cps_educ_tot.csv}\edtot
	\pgfplotstableread[header=true, col sep=comma]{data/cps_age.csv}\agesh
	\pgfplotstableread[header=true, col sep=semicolon]{data/union_ind.csv}\unmem
	\pgfplotstableread[header=true, col sep=semicolon]{data/quits_ind.csv}\quits
	\pgfplotstableread[header=true, col sep=semicolon]{data/state_pa_epop.csv}\paepop
	\pgfplotstableread[header=true, col sep=semicolon]{data/state_pa_epop2.csv}\paepopt
	\pgfplotstableread[header=true, col sep=semicolon]{data/state_pa_epop3.csv}\paepoptt
	\pgfplotstableread[header=true, col sep=semicolon]{data/openings_ind.csv}\opens
	\pgfplotstableread[header=true, col sep=comma]{data/nilf_comp.csv}\nilf
	\pgfplotstableread[header=true, col sep=comma]{data/pinc.csv}\pinc
	\pgfplotstableread[header=true, col sep=comma]{data/unemp_grp.csv}\ungrp
	\pgfplotstableread[header=true, col sep=comma]{data/unemp_grpsh.csv}\ungrpsh
	\pgfplotstableread[header=true, col sep=comma]{data/ce_age.csv}\ceage
	\pgfplotstableread[header=true, col sep=comma]{data/ce_inc.csv}\ceinc
	\pgfplotstableread[header=true, col sep=comma]{data/cpi_monthly.csv}\cpimo
	\pgfplotstableread[header=true, col sep=comma]{data/ccdebtbar.csv}\ccbar
	
	% Required for bar plots with individual bar colors for categories
	\pgfplotsset{discard if not/.style 2 args={
        x filter/.code={
            \edef\tempa{\thisrow{#1}}
            \edef\tempb{#2}
            \ifx\tempa\tempb
            \else
                \def\pgfmathresult{inf}
            \fi}}}	
	
% % % % % % % %
%
%  Begin Document
%
% % % % % % % %		
\begin{document}
\newpage
\begin{minipage}{0.76\textwidth}
\normalsize Manufacturing\\
\hspace*{-2mm} \begin{tikzpicture}
	\begin{axis}[\bbar{y}{0}, \ltdateaxisticks
		yticklabel style={text width=1.5em}, enlarge y limits={0.1},
		xticklabel={`\short{\year}}, width=4.6cm, height=3.4cm,
		clip=false]
	\rbar
	\thickline{blue!60!black}{date}{Man}{data/ces_ind_sh.csv}
	\end{axis}
\end{tikzpicture}\\
%\footnotesize{Source: Federal Reserve} \hfill \tbllink{msa_unemp_rate.csv}
\end{minipage}
\newpage
\begin{minipage}{0.76\textwidth}
\subsubsection*{Unemployment by Metro Area}
\vspace{-1mm}

\small The Bureau of Labor Statistics \href{https://www.bls.gov/lau/}{produce} local area estimates of unemployment, including the \textbf{unemployment rate for metro areas}. The following map shows changes since 2019 in metro area unemployment rates. An increase in the unemployment rate is shown by a blue circle and a decrease is shown by a light green circle; circle size is the magnitude of the change. 

\input{text/msa_unemp_ch_n.txt}
\end{minipage}
\vspace{1mm}

\begin{minipage}{0.82\textwidth}
\normalsize \textbf{Change in Unemployment Rate by Metro Area}\\
\footnotesize{\textit{from \input{text/unemp_map_date.txt}\unskip, percentage points}}
\vspace{-4mm}

\hspace*{-8mm} \input{data/unemp_msa.pgf}
\vspace{-3mm}

\footnotesize{Source: Bureau of Labor Statistics; \ Full Table: \tbllink{msa_unemp_rate.csv} \\ \**Pct Ch is percent change in labor force from \input{text/unemp_map_date.txt}}
\end{minipage}
\end{document}
